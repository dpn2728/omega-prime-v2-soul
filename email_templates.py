# email_templates.py (v5.1 - The Emperor's Edict, Sealed and Final)

import datetime

# --- I. HELPER FUNCTIONS & STYLING (рд╕рд╣рдпреЛрдЧреА рдХрд╛рд░реНрдпрд╣рд░реВ рд░ рд╢реИрд▓реА) ---

def _get_confidence_color(value, high_is_good=True):
    """рдорд╛рдирдХреЛ рдЖрдзрд╛рд░рдорд╛ рдЧрддрд┐рд╢реАрд▓ рд░реВрдкрдорд╛ HTML рд░рдЩ рдлрд░реНрдХрд╛рдЙрдБрдЫред"""
    if not isinstance(value, (int, float)): return "#e0e0e0"
    
    if high_is_good:
        if value >= 85: return "#28a745" # Green
        if value >= 60: return "#ffc107" # Yellow
        return "#dc3545" # Red
    else: # Low is good (e.g., risk score)
        if value <= 3: return "#28a745"
        if value <= 6: return "#ffc107"
        return "#dc3545"

def emperor_email_template(subject, content, version="v5.1"):
    """рд╕рдмреИ рд╢рд╛рд╣реА рдЖрджреЗрд╢рд╣рд░реВрдХреЛ рд▓рд╛рдЧрд┐ рдЕрдиреНрддрд┐рдо рд░ рдкрд░рд┐рд╖реНрдХреГрдд HTML рдЯреЗрдореНрдкреНрд▓реЗрдЯред"""
    return f"""
    <!DOCTYPE html><html><head><title>{subject.split('|')[0]}</title><style>body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #0a0a0a; color: #e0e0e0; }} .container {{ max-width: 800px; margin: 20px auto; background-color: #121212; border-radius: 10px; overflow: hidden; border: 1px solid #333; }} .header {{ padding: 20px; text-align: center; background: linear-gradient(135deg, #d4af37 0%, #a07d20 100%); }} .header h1 {{ margin: 0; color: #121212; font-size: 24px; font-weight: bold; }} .content {{ padding: 25px; }} h3 {{ color: #d4af37; border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 25px; font-size: 18px;}} table {{ width: 100%; border-collapse: collapse; margin-top: 15px; }} th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid #333; font-size: 14px; vertical-align: top; }} th {{ background-color: #1e1e1e; font-size: 14px; color: #d4af37; text-transform: uppercase; }} .footer {{ padding: 15px; text-align: center; font-size: 12px; color: #888; background-color: #0a0a0a; }} a {{ color: #d4af37; text-decoration: none; }} .button {{ background-color: #d4af37; color: #121212; padding: 12px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 5px; display: inline-block; }}</style></head><body><div class="container"><div class="header"><h1>{subject.split('|')[0]}</h1></div><div class="content">{content}</div><div class="footer"><p>OMEGA PRIME AI ({version}) | The Emperor's Final Word</p><p>This is an automated directive. Always conduct your own research.</p></div></div></body></html>
    """

def _generate_full_spectrum_body(coin_data):
    """
    рд╕рдмреИ рдЖрдХреНрд░рд╛рдордХ рдЖрджреЗрд╢рд╣рд░реВрдХреЛ рд▓рд╛рдЧрд┐ рдХреЗрдиреНрджреНрд░реАрдп "рд╕рдореНрд░рд╛рдЯрдХреЛ рдпреБрджреНрдз рдпреЛрдЬрдирд╛" рдЦрдгреНрдб рдЙрддреНрдкрдиреНрди рдЧрд░реНрджрдЫред
    рдпреЛ рдкреНрд░рдХрд╛рд░реНрдпрд▓реЗ рд╕рдмреИ рел рдЖрджреЗрд╢рд╣рд░реВрдорд╛ рдПрдХрд░реВрдкрддрд╛ рд░ рдкреВрд░реНрдгрддрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдЧрд░реНрджрдЫред
    """
    conviction = coin_data.get('conviction_score', 0)
    return f"""
        <div style="text-align: center; font-size: 12px; color: #888; margin-bottom: 20px;">
            Directive ID: G-{datetime.datetime.now().strftime("%Y%m%d-%H%M")} | 
            Conviction Score: <b style="color:{_get_confidence_color(conviction)}; font-size: 14px;">{conviction:.1f}%</b>
        </div>
        <h3>рез. рдХрд╛рд░реНрдпрдХрд╛рд░реА рд╕рд╛рд░рд╛рдВрд╢ (Executive Summary):</h3><p>{coin_data.get('summary', 'рдбрд╛рдЯрд╛ рдЙрдкрд▓рдмреНрдз рдЫреИрди')}</p>
        <h3>реи. AI рдХреЛ рдЖрдиреНрддрд░рд┐рдХ рдореЛрдиреЛрд▓рдЧ (AI's Internal Monologue):</h3><p style="border-left: 3px solid #d4af37; padding-left: 15px; font-style: italic; color: #aaa;">"{coin_data.get('ai_monologue', 'рдбрд╛рдЯрд╛ рдЙрдкрд▓рдмреНрдз рдЫреИрди')}"</p>
        <h3>рей. рдмрд╣реБ-рдХреНрд╖рд┐рддрд┐рдЬ рднрд╡рд┐рд╖реНрдпрд╡рд╛рдгреА (Multi-Horizon Prediction):</h3><table><tr><th>рд╕рдордп-рд╕реАрдорд╛</th><th>рдореВрд▓реНрдп рд╡реГрджреНрдзрд┐ рд╕рдореНрднрд╛рд╡рдирд╛ (>25%)</th><th>рдкреВрд░реНрд╡рд╛рдиреБрдорд╛рдирд┐рдд рд▓рдХреНрд╖реНрдп</th></tr><tr><td><b>рен рджрд┐рди</b></td><td style="color:{_get_confidence_color(coin_data.get('pred_prob_7d'))};"><b>{coin_data.get('pred_prob_7d', 'N/A')}%</b></td><td><b>~${coin_data.get('pred_target_7d', 'N/A')}</b></td></tr></table>
        <h3>рек. рдЙрддреНрдкреНрд░реЗрд░рдХ рд╡рд┐рд╢реНрд▓реЗрд╖рдг (Catalyst & Pre-Cognitive Signals):</h3><table><tr><th>рд╕рдЩреНрдХреЗрддрдХреЛ рд╕реНрд░реЛрдд</th><th>рд╡рд┐рд╢реНрд▓реЗрд╖рдг</th><th>рд╡рд┐рд╢реНрд╡рд╛рд╕</th></tr><tr><td><b>рднрд╡рд┐рд╖реНрдпрд╡рдХреНрддрд╛ рдЖрдБрдЦрд╛</b></td><td>Mempool: {coin_data.get('mempool_signal', 'рдбрд╛рдЯрд╛ рдЙрдкрд▓рдмреНрдз рдЫреИрди')}</td><td style="color:{_get_confidence_color(coin_data.get('mempool_confidence'))};"><b>{coin_data.get('mempool_confidence', 'N/A')}%</b></td></tr><tr><td><b>рд╢рд┐рдХрд╛рд░реАрдХреЛ рдкрджрдЪрд╛рдк</b></td><td>Smart Money: {coin_data.get('smart_money_signal', 'рдбрд╛рдЯрд╛ рдЙрдкрд▓рдмреНрдз рдЫреИрди')}</td><td style="color:{_get_confidence_color(coin_data.get('smart_money_confidence'))};"><b>{coin_data.get('smart_money_confidence', 'N/A')}%</b></td></tr></table>
        <h3>рео. рд╢рд╛рд╣реА рдЬреЛрдЦрд┐рдо рдореНрдпрд╛рдЯреНрд░рд┐рдХреНрд╕ (The Imperial Risk Matrix):</h3><table><tr><th>рдЬреЛрдЦрд┐рдордХреЛ рдкреНрд░рдХрд╛рд░</th><th>рдЬреЛрдЦрд┐рдо рд╕реНрддрд░ (1-10)</th><th>рд╕рд╛рд░рд╛рдВрд╢</th></tr><tr><td><b>рддрд░рд▓рддрд╛</b></td><td style="color:{_get_confidence_color(coin_data.get('risk_liquidity'), False)};"><b>{coin_data.get('risk_liquidity', 'N/A')}</b></td><td>{coin_data.get('risk_liquidity_summary', 'N/A')}</td></tr><tr><td><b>рдЕрд╕реНрдерд┐рд░рддрд╛</b></td><td style="color:{_get_confidence_color(coin_data.get('risk_volatility'), False)};"><b>{coin_data.get('risk_volatility', 'N/A')}</b></td><td>{coin_data.get('risk_volatility_summary', 'N/A')}</td></tr></table>
        <h3>реп. рд░рдгрдиреАрддрд┐рдХ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдпреЛрдЬрдирд╛ (Actionable Strategy):</h3><table><tr><th>рд╡рд┐рд╢реНрд▓реЗрд╖рдг</th><th>рдЖрджреЗрд╢ (Directive)</th></tr><tr><td><b>рдкреНрд░рд╡реЗрд╢ рдирд┐рд░реНрджреЗрд╢рди</b></td><td><b>Optimal Zone: ${coin_data.get('entry_low', 'N/A')} - ${coin_data.get('entry_high', 'N/A')}</b></td></tr><tr><td><b>рдЬреЛрдЦрд┐рдо рдиреНрдпреВрдиреАрдХрд░рдг</b></td><td><b>Hard stop-loss at ${coin_data.get('stop_loss', 'N/A')}. NO EXCEPTIONS.</b></td></tr></table>
        <h3>резреж. рддрд┐рдореНрд░реЛ рдорд┐рд╢рди (Your Mission):</h3><div style="text-align: center;"><a href="{coin_data.get('gateio_link', '#')}" class="button">Gate.io</a><a href="{coin_data.get('mexc_link', '#')}" class="button">MEXC</a><a href="{coin_data.get('website', '#')}" class="button">Website</a></div>
    """

# --- II. THE 5 ROYAL DECREES (рел рд╢рд╛рд╣реА рдЖрджреЗрд╢рд╣рд░реВ) ---

def generate_genesis_directive(coin_data):
    name = coin_data.get('name', 'N/A'); symbol = coin_data.get('symbol', 'N/A').upper()
    subject = f"ЁЯФе Omega Prime Genesis Directive | Emperor's Battle Plan: {name} ({symbol})"
    header = f"<h3>Investment Thesis</h3><p><b>Front-run a near-certain Tier-1 exchange listing, driven by god-tier fundamentals and verifiable pre-cognitive signals.</b></p>"
    body = _generate_full_spectrum_body(coin_data)
    return subject, emperor_email_template(subject, header + body)

def generate_hold_directive(market_data):
    subject = "ЁЯМЩ Omega Daily Summary | Hold Directive & Market Intel"
    content = f"<h3>рд░рдгрдиреАрддрд┐рдХ рд╕рд╛рд░рд╛рдВрд╢ (Strategic Summary)</h3><p>рдУрдореЗрдЧрд╛рд▓реЗ рдЖрдЬ рдХреБрдиреИ рдкрдирд┐ рдпреЛрдЧреНрдп рдЕрд╡рд╕рд░ рднреЗрдЯреНрдЯрд╛рдПрдиред рдЖрдЬрдХреЛ рдЖрджреЗрд╢: <b>рд╣реЛрд▓реНрдб / рдкреВрдБрдЬреА рд╕рдВрд░рдХреНрд╖рдг</b>ред рдЧрд▓рдд рдпреБрджреНрдзрдорд╛ рдкреНрд░рд╡реЗрд╢ рдирдЧрд░реНрдиреБ рдкрдирд┐ рдПрдХ рд╡рд┐рдЬрдп рд╣реЛред</p><p><i><b>рдЙрддреНрдХреГрд╖реНрдЯ, рддрд░ рдЕрдкрд░реНрдпрд╛рдкреНрдд рдЙрдореНрдореЗрджрд╡рд╛рд░:</b> {market_data.get('best_rejected', 'рдЖрдЬ рдХреБрдиреИ рдкрдирд┐ рд╕рд┐рдХреНрдХрд╛ рдирдЬрд┐рдХ рдЖрдПрдиред')}</i></p><h3>ЁЯУИ рдмрдЬрд╛рд░рдХреЛ рдкрд▓реНрд╕ (MARKET PULSE)</h3><table><tr><th>рдорд╛рдкрджрдгреНрдб</th><th>рдорд╛рди / рд╕реНрдерд┐рддрд┐</th></tr><tr><td><b>Fear & Greed Index</b></td><td>{market_data.get('fear_and_greed', 'N/A')}</td></tr><tr><td><b>Bitcoin Dominance</b></td><td>{market_data.get('btc_dominance', 'N/A')}%</td></tr></table><p><b>рдЕрд░реНрдХреЛ рд╕реНрдХреНрдпрд╛рди:</b> рд▓рдЧрднрдЧ {market_data.get('next_scan_hours', 8)} рдШрдгреНрдЯрд╛рдорд╛ред</p>"
    return subject, emperor_email_template(subject, content)

def generate_sleeping_giant_directive(coin_data):
    name = coin_data.get('name', 'N/A')
    subject = f"ЁЯМЯ Omega Contingency Directive | Sleeping Giant: {name}"
    header = f"<h2 style='color: #6c757d;'>рдЖрдХрд╕реНрдорд┐рдХ рдпреЛрдЬрдирд╛ рд╕рдХреНрд░рд┐рдп</h2><h3>Investment Thesis</h3><p><b>A long-term (6-12 months) value investment before the market wakes up. The catalyst is not imminent, but the value is immense.</b></p>"
    body = _generate_full_spectrum_body(coin_data)
    return subject, emperor_email_template(subject, header + body)

def generate_black_swan_directive(coin_data):
    name = coin_data.get('name', 'N/A')
    subject = f"ЁЯСБя╕П Omega Black Swan Directive | Anomaly Detected: {name}"
    header = f"<h2 style='color: #dc3545;'>рдЪреЗрддрд╛рд╡рдиреА: рдЙрдЪреНрдЪ-рдЬреЛрдЦрд┐рдо, рдЙрдЪреНрдЪ-рдкреНрд░рддрд┐рдлрд▓</h2><h3>Investment Thesis</h3><p><b>A calculated gamble on a potential paradigm shift. Max Allocation: <span style='color:#dc3545;'>0.5%</span> of portfolio.</b></p>"
    body = _generate_full_spectrum_body(coin_data)
    return subject, emperor_email_template(subject, header + body)

def generate_urgent_alpha_alert(coin_data):
    name = coin_data.get('name', 'N/A')
    subject = f"ЁЯФ┤ URGENT | Pre-Listing Anomaly Detected: {name}"
    header = f"<h2 style='color: #ffc107;'>рддрддреНрдХрд╛рд▓ рдХрд╛рд░рдмрд╛рд╣реА рдЖрд╡рд╢реНрдпрдХ</h2><p>рдУрдореЗрдЧрд╛рд▓реЗ рдЕрдХрд╛рдЯреНрдп, рд╕рдордп-рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдШрдЯрдирд╛ рджреЗрдЦреЗрдХреЛ рдЫ: <b>{coin_data.get('urgent_signal', 'Listing on a major exchange is imminent.')}</b></p><p><b>рд╡рд┐рд╢реНрд╡рд╛рд╕: <span style='color:#28a745;'>99%+</span> | рд╕рдордп-рд╕реАрдорд╛: <span style='color:#dc3545;'>рдЕрдиреБрдорд╛рдирд┐рдд рек рдШрдгреНрдЯрд╛рднрд┐рддреНрд░</span></b></p><h3>Investment Thesis</h3><p><b>Execute immediately via DEX to front-run the imminent CEX listing announcement.</b></p>"
    body = _generate_full_spectrum_body(coin_data)
    return subject, emperor_email_template(subject, header + body)
